# netAIS [![License: CC BY-SA 4.0](https://img.shields.io/badge/License-CC%20BY--SA%204.0-lightgrey.svg)](https://creativecommons.org/licenses/by-sa/4.0/)

## v. 1.4
Обмен AIS-подобными сообщениями с координатами и сопутствующей информацией через Интрнет между участниками выделенной группы. Для взаимодействия не требуется интернет-сервер с реальным адресом.

Удобно для организации коллективного плавания, соревнований, рыбалки.

![scheme](screenshots/art.png)   

Программное обеспечение использует [TOR](torproject.org) как среду коммуникации, и функционирует и через мобильный интернет и через публичные точки доступа wi-fi без дополнительных настроек.  
Координаты программное обеспечение получает от [gpsd](https://gpsd.io/) или [Signal K](https://signalk.org/).

Сообщения netAIS могут быть восприняты любым оборудованием или программным обеспечением, принимающим сообщения AIS.

## Возможности
* Создание одной выделенной группы
* Участие в любом количестве выделенных групп
* Веб-интерфейс на русском и английском языках

## Технические детали
Комплект программного обеспечения содержит клиентскую часть -- собственно для обмена сообщениями, и серверную часть, обеспечивающую эту возможность. Один сервер обслуживает одну выделенную группу и является скрытым сервисом TOR.  Если вы хотите организовать собственную группу, .onion адрес этого сервиса надо передать потенциальным членам группы каким-нибудь сторонним способом -- в sms, электронной или голубиной почтой. Каждый член вашей группы указывает этот адрес в своём клиенте, и клиент получает возможность обмениваться информацией с сервером через сеть TOR. В адресах обычного интернета нет необходимости.

Клиент сохраняет полученные от сервера сведения обо всех членах группы в файл. Файл может независимо считываться каким-то другим программным обеспечением для отображения на экране.  
Информация в файле представляет собой закодированный в JSON ассоциированный массив, где ключ -- это mmsi плавсредства, а значение -- ассоциированный массив AIS характеристик, как они описаны в gpsd/www/AIVDM.adoc (если у вас установлен gpsd) или на сайте [e-Navigation Netherlands](http://www.e-navigation.nl/system-messages), за исключением:  

* Все единицы измерения приведены к общепринятым
* Метка времени является временем Unix

Формат файла идентичен аналогичному по назначению фалу в проекте  [gpsdAISd](https://github.com/VladimirKalachikhin/gpsdAISd).

Картплотер [GaladrielMap](http://galadrielmap.hs-yachten.at/) читает информацию netAIS непосредственно из этого файла. Для взаимодействия с другим программным обеспечением имеется средство сетевого вещания, выдающее поток стандартных сообщений AIS.

## Демо
Общедоступная группа netAIS для тестовых целей:  
**2q6q4phwaduy4mly2mrujxlhpjg7el7z2b4u6s7spghylcd6bv3eqvyd.onion**  
Все активные участники группы видны в [демонстрационной версии](http://130.61.159.53/map/) [GaladrielMap](http://galadrielmap.hs-yachten.at/).

## Совместимость
Linux. 

## Зависимости
Требуется библиотека cURL и расширение php-curl -- для работы через TOR. К сожалению, замечательная функция _file_get_contents()_ не умеет socs proxy...

## Установка и конфигурирование:
На машине под управлением Linux должен быть установлен и сконфигурирован web сервер с поддержкой PHP и сервис [TOR service](https://2019.www.torproject.org/docs/tor-manual.html.en).  
Скопируйте файлы проекта в желаемый каталог web сервера и соответствующим образом исправьте пути в файле _params.php_.  
Установите права на запись в каталоги `data/` и `server/` для пользователя и/или группы web сервера (обычно это www-data).  
[Настройте скрытый сервис TOR](https://2019.www.torproject.org/docs/tor-onion-service.html.en) на каталог `server/`, если вы предполагаете держать свою выделенную группу. Если нет -- поднимать скрытый сервис нет необходимости.  
Если скрытый сервис сконфигурирован, укажите его адрес .onion в переменной $onion файла _params.php_.  Адрес находится в файле `hostname` по пути, указанном в файле конфигурации TOR `torrs`. (Например, в Ubuntu .onion адрес можно узнать, сказав: `# cat /var/lib/tor/hidden_service_netAIS/hostname`, если скрытый сервис описан в `torrc` именно как hidden_service_netAIS)  
Если вы хотите новый .onion адрес для скрытого сервиса -- удалите содержимое каталога скрытого сервиса и перезапустите TOR. Во вновь появившемся файле `hostname` будет новый адрес.

Укажите адрес и порт для службы AIS вещания, если предполагается использовать netAIS не только с [GaladrielMap](http://galadrielmap.hs-yachten.at/) в переменных $netAISdHost и $netAISdPort.

### Информация о судне
Информация о вашем судне, передаваемая участникам группы, содержится в файле _boatInfo.ini_. Лучше заполнить его содержательно.

### Геопозиционирование
Информацию о положении клиент netAIS обычно должен получать от демона **gpsd**, работающего на сервере. Установка и настройка gpsd описана на [сайте проекта](https://gpsd.io/). При необходимости в файле  _params.php_ можно указать фактический адрес и порт **gpsd**, если они отличаются от умолчальных. Если у вас уже установлен и настроен картплотер [GaladrielMap](http://galadrielmap.hs-yachten.at/) -- укажите те же адрес и порт **gpsd**.  
Если в локальной сети есть служба **Signal K**, то получение координат можно, в принципе, вообще не настраивать. Клиент netAIS попробует обнаружить **Signal K** и получить от неё координаты, если в файле конфигурации не указаны никакие источники геопозиционирования.  
Но лучше указать адрес **Signal K** в файле _params.php_

## Использование
Данные netAIS сторонними потребителями могут быть получены:

* Непосредственно из файла. Так работает [GaladrielMap](http://galadrielmap.hs-yachten.at/). Вся передаваемая информация доступна.
* Через сетевой ресурс по протоколу gpsd:// Кроме стандартной информации AIS передаются пользовательские текстовые поля.
* Через сетевой ресурс как поток стандартных сообщений AIS № 18, 24 и 27. Так могут быть подключены [OpenCPN](https://opencpn.org/), [OruxMaps](https://www.oruxmaps.com/cs/es), [Signal K](https://signalk.org/) и специализированные картплотеры. В этом случае доступны только стандартные возможности AIS.

Сетевой ресурс обслуживается отдельным демоном, отключенным по умолчанию. Включите его в _params.php_ и откройте веб-интерфейс.
 
### Настройка OpenCPN
Для отображения целей netAIS в [OpenCPN](https://opencpn.org/) сделайте следующее:  
Создайте сетевое подключение, как описано в [руководстве к OpenCPN](https://opencpn.org/wiki/dokuwiki/doku.php?id=opencpn:opencpn_user_manual:options_setting:connections#add_a_network_connection).  
Укажите "Протокол" -- TCP  
Укажите "Адрес" и "Порт связи" в соответствии с указанными в файле  _params.php_.  
![netAIS](screenshots/s13.png)<br>

### Настройка OruxMaps
Для отображения целей netAIS в [OruxMaps](https://www.oruxmaps.com/cs/es) сделайте следующее:  
В верхнем меню выберите крайний справа пункт "Ещё".  
Пройдите по пунктам меню  **Global settings** -> **Sensors** -> **AIS (nautical)**  
В разделе AIS (nautical):  
Отметьте пункт **Enable AIS**.  
Установите в **GPS-AIS-NMEA source** значение IP.
Установите в **AIS IP address** адрес и порт в соответствии с файлом _params.php_  
После этого надо включить отображение целей AIS. Закройте меню настроек, и в верхнем меню главного экрана выберите пункт "Маршруты".  
Откройте меню **Sensors** и выберите **Start AIS**.

### Настройка Signal K
Просто добавьте источник данных "Server -> Data Connections" со следующими параметрами:  
Data Type: NMEA0183  
NMEA 0183 Source: TCP Client  
Host: {адрес, указанный в переменной $netAISdHost в файле _params.php_, по умолчанию -- localhost}  
Port: {порт, указанный в переменной $netAISdPort в файле _params.php_, по умолчанию -- 3838}  

## Веб-интерфейс
![screen](screenshots/s1r.png)   
Веб-интерфейс позволяет: 

* Включить - выключить обслуживание вашей выделенной группы (верхняя секция). Если обслуживание выключено, обращения к скрытому сервису TOR не приведут ни к какому результату. Но быть членом других групп вы сможете.
* Подключение к другим группам и создание нового подключения (средняя секция). Подключение к своей группе будет создано автоматически. Левая кнопка каждого подключения включает - выключает видимость группы для вас и вас для группы.
* Указать свой собственный статус, как он будет транслироваться участникам группы (нижняя секция).

Веб-интерфейс оптимизирован для мобильный устройств и устройств с экраном на электронных чернилах (e-Inc), в том числе и старых. Производительности от устройств не требуется.

## Благодарности
* [Aaron Gong Hsien-Joen](https://github.com/ais-one/phpais) за код создания сообщений AIS.
* [Metrize Icons by Alessio Atzeni](https://icon-icons.com/pack/Metrize-Icons/1130) за значки.

## Поддержка
[Обсуждение](https://github.com/VladimirKalachikhin/netAIS/discussions)

За чашку кофе [через ЯндексДеньги](https://yasobe.ru/na/galadrielmap) или [PayPal](https://paypal.me/VladimirKalachikhin?locale.x=ru_RU) можно получить консультации по адресу [galadrielmap@gmail.com](mailto:galadrielmap@gmail.com)  